`begin_keywords "1800-2017"
`line 1 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 1

 

`line 4 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
 
 

`line 7 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 

`line 23 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
 
 
 

`line 27 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
 
 
 
 

`line 32 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
 


`line 35 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
module tlul_socket_1n #(
  parameter int unsigned  N         = 4,
  parameter bit           HReqPass  = 1'b1,
  parameter bit           HRspPass  = 1'b1,
  parameter bit [N-1:0]   DReqPass  = {N{1'b1}},
  parameter bit [N-1:0]   DRspPass  = {N{1'b1}},
  parameter bit [3:0]     HReqDepth = 4'h2,
  parameter bit [3:0]     HRspDepth = 4'h2,
  parameter bit [N*4-1:0] DReqDepth = {N{4'h2}},
  parameter bit [N*4-1:0] DRspDepth = {N{4'h2}},
  localparam int unsigned NWD       = $clog2(N+1)  
) (
  input  logic                   clk_i,
  input  logic                   rst_ni,
  input  tlul_pkg::tlul_h2d_t tl_h_i,
  output tlul_pkg::tlul_d2h_t tl_h_o,
  output tlul_pkg::tlul_h2d_t tl_d_o    [N],
  input  tlul_pkg::tlul_d2h_t tl_d_i    [N],
  input  logic [NWD-1:0]          dev_select_i
);

`line 56 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
   
   

`line 59 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
   

`line 61 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
   
  logic [NWD-1:0] dev_select_t;

`line 64 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  tlul_pkg::tlul_h2d_t   tl_t_o;
  tlul_pkg::tlul_d2h_t   tl_t_i;

`line 67 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  tlul_fifo_sync #(
    .ReqPass(HReqPass),
    .RspPass(HRspPass),
    .ReqDepth(HReqDepth),
    .RspDepth(HRspDepth),
    .SpareReqW(NWD)
  ) fifo_h (
    .clk_i,
    .rst_ni,
    .tl_h_i,
    .tl_h_o,
    .tl_d_o     (tl_t_o),
    .tl_d_i     (tl_t_i),
    .spare_req_i (dev_select_i),
    .spare_req_o (dev_select_t),
    .spare_rsp_i (1'b0),
    .spare_rsp_o ());


`line 86 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
   
   
   
  localparam int MaxOutstanding = 4**tlul_pkg::TL_AIW;  
  localparam int OutstandingW = $clog2(MaxOutstanding+1);
  logic [OutstandingW-1:0] num_req_outstanding;
  logic [NWD-1:0]          dev_select_outstanding;
  logic                    hold_all_requests;
  logic                    accept_t_req, accept_t_rsp;

`line 96 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  assign  accept_t_req = tl_t_o.a_valid & tl_t_i.a_ready;
  assign  accept_t_rsp = tl_t_i.d_valid & tl_t_o.d_ready;

`line 99 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  always_ff @(posedge clk_i or negedge rst_ni) begin
    if (!rst_ni) begin
      num_req_outstanding <= '0;
      dev_select_outstanding <= '0;
    end else if (accept_t_req) begin
      if (!accept_t_rsp) begin
        num_req_outstanding <= num_req_outstanding + 1'b1;
      end
      dev_select_outstanding <= dev_select_t;
    end else if (accept_t_rsp) begin
      num_req_outstanding <= num_req_outstanding - 1'b1;
    end
  end

`line 113 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  assign hold_all_requests =
      (num_req_outstanding != '0) &
      (dev_select_t != dev_select_outstanding);

`line 117 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
   
   

`line 120 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  tlul_pkg::tlul_h2d_t   tl_u_o [N+1];
  tlul_pkg::tlul_d2h_t   tl_u_i [N+1];

`line 123 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  for (genvar i = 0 ; i < N ; i++) begin : gen_u_o
    assign tl_u_o[i].a_valid   = tl_t_o.a_valid &
                                 (dev_select_t == NWD'(i)) &
                                 ~hold_all_requests;
    assign tl_u_o[i].a_opcode  = tl_t_o.a_opcode;
    assign tl_u_o[i].a_param   = tl_t_o.a_param;
    assign tl_u_o[i].a_size    = tl_t_o.a_size;
    assign tl_u_o[i].a_source  = tl_t_o.a_source;
    assign tl_u_o[i].a_address = tl_t_o.a_address;
    assign tl_u_o[i].a_mask    = tl_t_o.a_mask;
    assign tl_u_o[i].a_data    = tl_t_o.a_data;
  end

`line 136 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  tlul_pkg::tlul_d2h_t tl_t_p ;

`line 138 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
   
  logic hfifo_reqready;
  always_comb begin
    hfifo_reqready = tl_u_i[N].a_ready;  
    for (int idx = 0 ; idx < N ; idx++) begin
       
      if (dev_select_t == NWD'(idx)) hfifo_reqready = tl_u_i[idx].a_ready;
    end
    if (hold_all_requests) hfifo_reqready = 1'b0;
  end
   
   
  assign tl_t_i.a_ready = tl_t_o.a_valid & hfifo_reqready;

`line 152 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  always_comb begin
    tl_t_p = tl_u_i[N];
    for (int idx = 0 ; idx < N ; idx++) begin
      if (dev_select_outstanding == NWD'(idx)) tl_t_p = tl_u_i[idx];
    end
  end
  assign tl_t_i.d_valid  = tl_t_p.d_valid ;
  assign tl_t_i.d_opcode = tl_t_p.d_opcode;
  assign tl_t_i.d_param  = tl_t_p.d_param ;
  assign tl_t_i.d_size   = tl_t_p.d_size  ;
  assign tl_t_i.d_source = tl_t_p.d_source;
  assign tl_t_i.d_sink   = tl_t_p.d_sink  ;
  assign tl_t_i.d_data   = tl_t_p.d_data  ;
  assign tl_t_i.d_error  = tl_t_p.d_error ;


`line 168 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
   
  for (genvar i = 0 ; i < N+1 ; i++) begin : gen_u_o_d_ready
    assign tl_u_o[i].d_ready = tl_t_o.d_ready;
  end

`line 173 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
   
  for (genvar i = 0 ; i < N ; i++) begin : gen_dfifo
    tlul_fifo_sync #(
      .ReqPass(DReqPass[i]),
      .RspPass(DRspPass[i]),
      .ReqDepth(DReqDepth[i*4+:4]),
      .RspDepth(DRspDepth[i*4+:4])
    ) fifo_d (
      .clk_i,
      .rst_ni,
      .tl_h_i      (tl_u_o[i]),
      .tl_h_o      (tl_u_i[i]),
      .tl_d_o      (tl_d_o[i]),
      .tl_d_i      (tl_d_i[i]),
      .spare_req_i (1'b0),
      .spare_req_o (),
      .spare_rsp_i (1'b0),
      .spare_rsp_o ());
  end

`line 193 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
  assign tl_u_o[N].a_valid     = tl_t_o.a_valid &
                                 (dev_select_t == NWD'(N)) &
                                 ~hold_all_requests;
  assign tl_u_o[N].a_opcode    = tl_t_o.a_opcode;
  assign tl_u_o[N].a_param     = tl_t_o.a_param;
  assign tl_u_o[N].a_size      = tl_t_o.a_size;
  assign tl_u_o[N].a_source    = tl_t_o.a_source;
  assign tl_u_o[N].a_address   = tl_t_o.a_address;
  assign tl_u_o[N].a_mask      = tl_t_o.a_mask;
  assign tl_u_o[N].a_data      = tl_t_o.a_data;
  tlul_err_resp err_resp (
    .clk_i      (clk_i),
    .rst_ni     (rst_ni),
    .tl_h_i     (tl_u_o[N]),
    .tl_h_o     (tl_u_i[N]));

`line 209 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 0
endmodule

`line 211 "../src/merl_azadi-II_azadi_common_1.0/rtl/tlul_socket_1n.sv" 2
